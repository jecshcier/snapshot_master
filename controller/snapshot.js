"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));Object.defineProperty(exports,"__esModule",{value:!0});var Router=require("koa-router"),child=require("child_process"),path=require("path"),uuidv1=require("uuid/v1"),config_1=require("../config"),snapshot_service_1=require("../service/snapshot.service"),createSnapshot=path.join(__dirname,"../process/createSnapshot"),router=new Router;function default_1(i){var p=new snapshot_service_1.default(i);router.get("/",function(r){return _regenerator.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_regenerator.default.awrap(r.render("snapshot",{title:"截屏工具 V1.0"}));case 2:case"end":return e.stop()}})}),router.post("/getSnapshot",function(r){var t,s,a,n,o,u,c;return _regenerator.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body.url,s=parseInt(r.request.body.width,10),a=r.request.body.isMobile,n=r.request.body.userAgent,t){e.next=7;break}return r.response.body=i.responseMessage.successMessage({msg:"url不能为空",key:null}),e.abrupt("return",!1);case 7:o=child.fork(createSnapshot,[],{}),u=uuidv1(),c="image".concat(+new Date+Math.floor(1e5*Math.random()),".png"),o.on("message",function(r){return _regenerator.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.flag)return e.prev=1,e.next=4,_regenerator.default.awrap(p.createSnapshot({id:u,snap_url:t,file_name:c,preview_url:"".concat(config_1.default.DOMAIN).concat(config_1.default.STATIC.prefix,"/").concat(config_1.default.DIR.cacheDir,"/").concat(c),img_flag:0}));e.next=11;break;case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1);case 9:e.next=19;break;case 11:return e.prev=11,e.next=14,_regenerator.default.awrap(p.createSnapshot({id:u,snap_url:t,file_name:c,preview_url:"".concat(config_1.default.DOMAIN).concat(config_1.default.STATIC.prefix,"/").concat(config_1.default.DIR.cacheDir,"/").concat(c),img_flag:1}));case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(11);case 19:case"end":return e.stop()}},null,null,[[1,6],[11,16]])}),o.send({url:t,fileName:c,width:s,isMobile:!!a,userAgent:n||"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"}),r.response.body=i.responseMessage.successMessage({key:u});case 14:case"end":return e.stop()}})}),router.post("/getSnapshotImg",function(r){var t,s;return _regenerator.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.request.body.key,e.prev=1,e.next=4,_regenerator.default.awrap(p.getSnapshot(t));case 4:s=e.sent,(s=JSON.parse(JSON.stringify(s)))?1===s.img_flag?r.response.body=i.responseMessage.errorMessage({errCode:2,msg:"截图生成失败，请确保网址正确！"}):2===s.img_flag?r.response.body=i.responseMessage.errorMessage({errCode:3,msg:"截图已被过期清理！"}):r.response.body=i.responseMessage.successMessage({url:s.preview_url}):r.response.body=i.responseMessage.errorMessage({msg:"未找到图片"}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),r.response.body=i.responseMessage.errorMessage({msg:"未找到图片"});case 13:case"end":return e.stop()}},null,null,[[1,9]])}),i.use(router.routes(),router.allowedMethods())}router.prefix("/snapshot"),exports.default=default_1;